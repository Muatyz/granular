clear;clc;
addpath('../include/')

[tspan_raw, Amp_raw, fspan_raw, dft_raw] = csvRead("小容器-2mm钢珠-36mm-100hz-10vpp-2us-0应力.csv");
Int = intensity(Amp_raw)/50;

%%% Response function correction
[tspan_corrected, Amp_corrected, fspan_corrected, DFT_corrected] = response_correct(Amp_raw, 0);


%%% High-Pass Filter
fs = 2000e3; % Sample freq
fc_highpass = 150e3; % High-Pass cut-off freq

order = 4;
[b,a] = butter(order,fc_highpass/(fs/2), 'high');
Amp_corrected_filtered = filter(b, a, Amp_corrected);

DFT_corrected_filtered = abs(fft(Amp_corrected_filtered))*2;
num = length(Amp_corrected_filtered);
Freq = num / 5 * 10^3;
half_num = floor(num / 2);
fspan = (0:num - 1) * (Freq / num);
fspan_corrected_filtered = fspan(1:half_num) / 10^3; % Here the unit is 1kHz
dft_corrected_filtered = DFT_corrected_filtered(1:half_num);


% figure(1)
% plot(tspan*10^3, Amp),xlabel("Time(ms)"),ylabel("Amplitude(V)")
% 
% figure(2)
% plot(fspan, dft),xlabel("Frequency(kHz)"),ylabel("Magnitude(V)")
% 
% figure(3)
% plot(tspan*10^3, Int),xlabel("Time(ms)"),ylabel("Power(W)")
% 
% figure(4)
% plot(tspan*10^3, envelope(log10(Int))),xlabel("Time(ms)"),ylabel("log I(a.u.)")
% xlim([1.5, 4])
% 
% figure(5)
% subplot(4,1,1)
% plot(tspan*10^3, Amp),xlabel("Time(ms)"),ylabel("Amplitude(V)")
% subplot(4,1,2)
% plot(fspan, dft),xlabel("Frequency(kHz)"),ylabel("Magnitude(V)")
% subplot(4,1,3)
% plot(tspan*10^3, Int),xlabel("Time(ms)"),ylabel("Power(W)")
% subplot(4,1,4)
% plot(tspan*10^3, envelope(log10(Int))),xlabel("Time(ms)"),ylabel("log I(a.u.)")
% xlim([1.5, 4])

figure(6)
%%% Original Signal
subplot(3,2,1)
plot(tspan_raw*10^3, Amp_raw),xlabel("Time(ms)"),ylabel("Amplitude(V)")
subplot(3,2,2)
plot(fspan_raw,abs(dft_raw)),xlabel("Frequency(kHz)"),ylabel("Magnitude(V)")

%%% Corrected Signal
subplot(3,2,3)
plot(tspan_corrected*10^3, Amp_corrected),xlabel("Time(ms)"),ylabel("Amplitude(V)")
subplot(3,2,4)
plot(fspan_filtered, abs(dft_filtered)),xlabel("Frequency(kHz)"),ylabel("Magnitude(V)")

%%% Filter the corrected signal
subplot(3,2,5)

subplot(3,2,6)
